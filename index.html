<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŠ¹å¤ªæ°‘æ—å†å²è¿å¾™åœ°å›¾ - åˆ›æ„ä½œä¸š</title>
    <!-- å¼•ç”¨æœ¬åœ°Leaflet CSS -->
    <link rel="stylesheet" href="./leaflet.css">
    <style>
        /* Ensure html takes full height */
        html {
            height: 100%;
            overflow: hidden; /* Prevent scrollbar on html */
        }
        /* åŸºç¡€é‡ç½® */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            background-color: #fff;
            display: flex;
            flex-direction: column;
            height: 100%; /* Use height 100% instead of min-height */
            color: #333;
            overflow: hidden; /* Prevent scrollbar on body */
        }

        /* å¤´éƒ¨æ ·å¼ */

        header {
            /* Keep the original background layers */
            background-color: #0056b3; /* Fallback color */
            background-image:
                /* Subtle diagonal lines pattern */
                repeating-linear-gradient(
                    45deg,
                    rgba(255, 255, 255, 0.05),
                    rgba(255, 255, 255, 0.05) 1px,
                    transparent 1px,
                    transparent 10px
                ),
                /* Blue gradient */
                linear-gradient(135deg, #0038a8 0%, #0056b3 100%);

            padding: 10px 0; /* ä¿®æ”¹æ°´å¹³å†…è¾¹è·ä¸º0 */
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Slightly softer shadow */
            position: absolute; /* Position absolutely to overlay the map */
            top: 0;             /* Align to the top of the viewport */
            left: 0;            /* Align to the left of the viewport */
            width: 100%;        /* Take full width */
            z-index: 1000; /* Ensure header is above map */
            border-bottom: none; /* Remove the border as it interferes with the fade */
            pointer-events: none; /* Allow clicks to pass through transparent areas to the map */

            /* Adjust the mask to fade out faster */
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%); /* Fade starts earlier, finishes sooner */
            -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 80%); /* For Safari/Chrome compatibility */

            /* Reduce extra padding at the bottom */
            padding-bottom: 50px; /* Less padding needed now */

            /* æ–°å¢ï¼šç¡®ä¿æ ‡é¢˜å®¹å™¨å¯¹é½æ–¹å¼æ­£ç¡® */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header h1 {
            margin: 0 auto; /* ä½¿ç”¨ margin: 0 auto ç¡®ä¿æ°´å¹³å±…ä¸­ */
            font-size: 2.2em; /* Slightly larger font size */
            color: #FFDA00;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3); /* Slightly stronger text shadow */
            font-weight: 600;
            letter-spacing: 1px; /* Add subtle letter spacing for elegance */
            pointer-events: auto; /* Make the H1 clickable/selectable again */
            /* ç¡®ä¿æ–‡æœ¬åœ¨å…¶å®¹å™¨å†…å±…ä¸­ */
            text-align: center;
            width: fit-content;
            padding: 0 20px; /* æ·»åŠ ä¸€äº›æ°´å¹³å†…è¾¹è· */
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ - Flexå¸ƒå±€ */
        main {
            flex-grow: 1; /* Allow main to grow and fill body */
            display: flex;
            flex-direction: column; /* Default direction */
            position: relative;
            min-height: 0; /* Crucial for flex children height calculation */
            overflow: hidden; /* Prevent main from overflowing */
        }

        #mapid {
            flex-grow: 1; /* Allow map to take remaining space */
            width: 100%;
            background-color: #4a90e2;
            order: 1;
            position: relative;
            z-index: 1;
            min-height: 0; /* Add min-height 0 for flex sizing */
        }

        .leaflet-container {
            background: none;
        }

        /* Custom Icons (all markers use star image) */
        .leaflet-marker-icon.star-of-david-marker {
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
            cursor: pointer;
        }

        /* Popup Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.98);
            border: 1px solid #ddd;
            opacity: 1;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-close-button {
            color: #555;
            font-size: 18px;
            top: 8px;
            right: 8px;
        }

        .leaflet-popup-content {
            width: auto !important;
            min-width: 280px;
            max-width: 800px;
            color: #333;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 10px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .leaflet-popup-content::-webkit-scrollbar {
            width: 6px;
        }

        .leaflet-popup-content::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .leaflet-popup-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .popup-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #004a99;
            margin-bottom: 8px;
            border-bottom: 2px solid #004a99;
            padding-bottom: 6px;
        }

        .popup-header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 2px solid #004a99;
            padding-bottom: 6px;
        }

        .popup-music-inline {
            margin-top: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .popup-music-inline .music-title-inline {
            font-size: 0.9em;
            color: #555;
            font-style: italic;
            margin-right: 10px;
        }

        .popup-music-inline audio {
            width: 150px;
            height: 30px;
            flex-shrink: 0;
        }

        .popup-section {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #ccc;
        }

        .popup-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .popup-section h4 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.05em;
            color: #555;
            font-weight: bold;
        }

        .popup-background,
        .popup-proverb {
            font-size: 1em;
            line-height: 1.6;
            color: #666;
        }

        .popup-proverb .hebrew {
            font-family: 'David Libre', 'Arial', sans-serif;
            direction: rtl;
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
            color: #0038a8;
            font-weight: bold;
            text-align: right;
            line-height: 1.4;
        }

        .popup-proverb .chinese {
            font-size: 1em;
            color: #333;
            line-height: 1.4;
        }

        .popup-music h4 {
            margin-bottom: 8px;
        }

        .popup-music p {
            margin-bottom: 8px;
            font-style: italic;
            color: #555;
            font-size: 1em;
        }

        .popup-music audio {
            width: 100%;
            margin-top: 5px;
        }

        .leaflet-tooltip {
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #bbb;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 0.85em;
            color: #333;
            font-weight: bold;
            white-space: nowrap;
            z-index: 100;
            cursor: pointer;
        }

        .leaflet-tooltip.leaflet-tooltip-top:before {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        .leaflet-tooltip.leaflet-tooltip-bottom:before {
            border-bottom-color: rgba(255, 255, 255, 0.95);
        }

        .leaflet-tooltip.leaflet-tooltip-left:before {
            border-left-color: rgba(255, 255, 255, 0.95);
        }

        .leaflet-tooltip.leaflet-tooltip-right:before {
            border-right-color: rgba(255, 255, 255, 0.95);
        }

        .info-bar {
            width: 100%;
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            font-size: 0.95em;
            line-height: 1.5;
            color: #555;
            flex-shrink: 0;
            order: 2;
            z-index: 1000;
            position: relative;
            transition: max-height 0.3s ease, padding 0.3s ease;
            max-height: 50vh;
        }

        .info-bar h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .info-bar.collapsed h2 {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-bar .info-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .info-bar.collapsed .info-content {
            opacity: 0;
            pointer-events: none;
        }

        #info-toggle-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            z-index: 1001;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #info-toggle-button:hover {
            background-color: #0038a8;
        }

        .leaflet-control-attribution {
            display: none;
        }

        .leaflet-control-zoom {
            position: absolute;
            top: 50%;
            left: 100px;
            transform: translateY(-50%);
            z-index: 10;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }

        .leaflet-control-zoom a {
             background-color: white;
             color: #333;
        }
         .leaflet-control-zoom a:hover {
             background-color: #f4f4f4;
         }

        @media (min-width: 768px) {
            main {
                flex-direction: row;
            }

            #mapid {
                flex-grow: 1;
                order: 1;
                min-height: 0;
            }

            .info-bar {
                width: 320px;
                height: 100%;
                box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
                order: 2;
                padding: 15px 20px;
                max-height: 100%;
                transition: width 0.3s ease, padding 0.3s ease;
                overflow-y: auto;
                flex-shrink: 0;
            }

            .info-bar.collapsed {
                width: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                background: transparent !important;
            }

            .info-bar.collapsed .info-content,
            .info-bar.collapsed h2 {
                display: none !important;
            }

            .info-bar.collapsed #info-toggle-button {
                position: fixed;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
                z-index: 1002;
                left: auto;
            }

            body {
                min-height: auto;
            }

            .info-bar.collapsed {
                max-height: none !important;
                height: 0 !important;
                width: 0 !important;
                overflow: visible !important;
            }

            .info-bar.collapsed #info-toggle-button {
                top: 100px;
                right: 6px;
                left: auto;
            }
        }

        .migration-line-hover {
            stroke-width: 5 !important;
            stroke: #FFDA00 !important;
            stroke-opacity: 1 !important;
        }
    </style>
    <!-- Try linking a Google Font for Hebrew (Optional, needs local download for offline) -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&display=swap" rel="stylesheet"> -->

</head>

<body>

    <header>
        <h1>çŠ¹å¤ªæ°‘æ—å†å²è¿å¾™åœ°å›¾</h1>
    </header>

    <main>
        <div id="mapid"></div>
        <div class="info-bar">
            <button id="info-toggle-button">æ”¶èµ·</button> <!-- Toggle Button -->
            <div class="info-content">
                <h2>åˆ›æ„ä½œä¸šè¯´æ˜</h2>
                <p>æ­¤åœ°å›¾åŠ¨æ€å‘ˆç°çŠ¹å¤ªæ°‘æ—é‡è¦çš„å†å²è¿å¾™è·¯çº¿ã€‚</p>
                <p>åœ°å›¾ä¸Šçš„è“è‰²è™šçº¿ä»£è¡¨è¿å¾™è·¯çº¿ï¼Œ<strong>å…­èŠ’æ˜Ÿ</strong>æ ‡è®°é‡è¦åœ°ç‚¹ï¼ˆèµ·ç‚¹æˆ–ç»ˆç‚¹ï¼‰ã€‚</p>
                <p>ç‚¹å‡»æ ‡è®°å›¾æ ‡æˆ–åœ°åæ ‡ç­¾ï¼Œå³å¯æŸ¥çœ‹è¯¥è¿å¾™äº‹ä»¶çš„ä¿¡æ¯ã€å¡”æœ¨å¾·ç®´è¨€åŠéŸ³ä¹ã€‚</p>
                <p><strong>æ³¨æ„ï¼š</strong>åœ°å›¾åº•å›¾ä¸ºä¸€å¼ é™æ€å›¾ç‰‡ï¼Œåæ ‡ç³»å¯èƒ½å­˜åœ¨å¾®å°åå·®ï¼›å¸Œä¼¯æ¥æ–‡æ˜¾ç¤ºæ•ˆæœå–å†³äºæ‚¨çš„æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨æ˜¯å¦æ”¯æŒç›¸åº”çš„å­—ä½“ï¼›è¿çº¿ä½¿ç”¨ Leaflet-Curve
                    æ’ä»¶ç»˜åˆ¶ï¼›éŸ³é¢‘æ–‡ä»¶éœ€è¦æœ¬åœ°å­˜åœ¨æ‰èƒ½æ­£å¸¸æ’­æ”¾ã€‚</p>
            </div>
        </div>
    </main>


    <!-- å¼•ç”¨æœ¬åœ°Leaflet JS -->
    <script src="./leaflet.js"></script>
    <!-- å¼•ç”¨æœ¬åœ°Leaflet-Curve JS -->
    <script src="./leaflet.curve.js"></script>
    <!-- REMOVED Leaflet-Arrowheads JS reference as it won't work with file:// -->
    <script src="./leaflet.polylineDecorator.js"></script>


    <script>
        // Define map center and initial zoom level
        const initialCoords = [30.0444, 31.2357]; // Approximate Middle East location
        const initialZoom = 4;
        const minZoom = 3; // â˜…â˜…â˜… æ‚¨å¯ä»¥åœ¨è¿™é‡Œè°ƒæ•´åœ°å›¾çš„æœ€å°ç¼©æ”¾çº§åˆ« (1 è¡¨ç¤ºå…¨çƒèŒƒå›´ï¼Œé˜²æ­¢è¿‡åº¦ç¼©å°) â˜…â˜…â˜…
        const maxZoom = 6; // Maximum zoom level (controls maximum zoom in)

        // Create map instance
        const map = L.map('mapid', {
            crs: L.CRS.EPSG4326,
            minZoom: minZoom, // Minimum zoom level (controls maximum zoom out)
            maxZoom: maxZoom, // Maximum zoom level (controls maximum zoom in)
            center: initialCoords,
            zoom: initialZoom,
            attributionControl: false, // Hide default Leaflet attribution
            maxBounds: [[-90, -180], [90, 180]], // Restrict panning to world bounds
            maxBoundsViscosity: 1.0, // Make bounds "hard"
            autoPanPadding: L.point(80, 80) // Padding when auto-panning to show popup
        });

        // Add world map image as base layer
        const imageUrl = './world-map.jpg';
        const imageBounds = [[-90, -180], [90, 180]]; // [south, west], [north, east]
        L.imageOverlay(imageUrl, imageBounds).addTo(map);

        // Define Star of David Icon (L.icon using an image) - Used for ALL markers now
        const starOfDavidIcon = L.icon({
            iconUrl: './star.png', // Path to your Star of David image
            iconSize: [30, 30], // Image size (adjust based on your star.png)
            iconAnchor: [15, 15], // Center anchor (iconSize / 2)
            popupAnchor: [0, -15], // Popup position relative to anchor
            className: 'star-of-david-marker' // Add a class for CSS styling (shadow etc.)
        });


        // Define migration data
        const migrations = [
            {
                start: { name: 'å¤ä»£åŸƒåŠ', coords: [30.0444, 31.2357] }, // Cairo area
                end: { name: 'è¿¦å—ï¼ˆä»Šä»¥è‰²åˆ—åœ°åŒºï¼‰', coords: [31.7683, 35.2137] }, // Jerusalem area
                time: 'çº¦å…¬å…ƒå‰13ä¸–çºª',
                background: 'åœ£ç»è®°è½½æ‘©è¥¿å¸¦é¢†å¸Œä¼¯æ¥äººé€ƒç¦»åŸƒåŠå¥´å½¹ï¼Œç»è¿‡æ—·é‡å››åå¹´æŠµè¾¾åº”è®¸ä¹‹åœ°è¿¦å—ï¼Œæ ‡å¿—ç€çŠ¹å¤ªæ°‘æ—è¯ç”Ÿå’Œè¿½æ±‚è‡ªç”±çš„èµ·ç‚¹ã€‚',
                proverb_he: '×‘Ö°Ö¼×›Ö¸×œ ×“Ö¼×•Ö¹×¨ ×•Ö¸×“×•Ö¹×¨ ×—Ö·×™Ö¸Ö¼×‘ ×Ö¸×“Ö¸× ×œÖ´×¨Ö°××•Ö¹×ª ×Ö¶×ª ×¢Ö·×¦Ö°××•Ö¹ ×›Ö°Ö¼×Ö´×œÖ¼×•Ö¼ ×”×•Ö¼× ×™Ö¸×¦Ö¸× ×Ö´×Ö´Ö¼×¦Ö°×¨Ö·×™Ö´×',
                proverb_zh: 'æ¯ä¸€ä¸–ä»£çš„äººéƒ½åº”çœ‹è‡ªå·±ä»¿ä½›äº²èº«ç»å†è¿‡å‡ºåŸƒåŠã€‚',
                music: { title: 'ã€Šå½“ä½ ç›¸ä¿¡ã€‹(åŠ¨ç”»ã€ŠåŸƒåŠç‹å­ã€‹ä¸»é¢˜æ›²)', file: 'music/exodus.mp3' }
            },
            {
                start: { name: 'è€¶è·¯æ’’å†·', coords: [31.7683, 35.2137] },
                end: { name: 'å·´æ¯”ä¼¦ï¼ˆä¸¤æ²³æµåŸŸï¼‰', coords: [33.3152, 44.3661] }, // Baghdad area
                time: 'å…¬å…ƒå‰597â€“538å¹´',
                background: 'å°¼å¸ƒç”²å°¼æ’’äºŒä¸–æ”»é™·è€¶è·¯æ’’å†·ï¼Œç¬¬ä¸€åœ£æ®¿è¢«æ¯ï¼Œå¤§æ‰¹çŠ¹å¤ªäººï¼ˆå°¤è¾¾ç‹å›½å±…æ°‘ï¼‰è¢«å¼ºåˆ¶è¿å¾€å·´æ¯”ä¼¦ã€‚åœ¨å¼‚ä¹¡ç»å†åŠä¸ªä¸–çºªçš„â€œå·´æ¯”ä¼¦ä¹‹å›šâ€ï¼ŒçŠ¹å¤ªäººåšæŒä¿¡ä»°å’Œèº«ä»½è®¤åŒï¼Œç­‰å¾…å½’è¿”é‡å»ºå®¶å›­ã€‚',
                proverb_he: '×‘×›×œ ××§×•× ×©×’×œ×• ×™×©×¨××œ, ×©×›×™× ×” ×¢××”×',
                proverb_zh: 'æ— è®ºè¢«æ”¾é€åˆ°ä½•å¤„ï¼Œç¥çš„åœ£ä¸´éƒ½ä¸ä»–ä»¬åŒåœ¨ã€‚',
                music: { title: 'å¨å°”ç¬¬æ­Œå‰§ã€Šçº³å¸ƒç§‘ã€‹ä¸­çš„â€œé£å§ï¼Œæ€æƒ³â€åˆå”±', file: 'music/nabucco.mp3' }
            },
            {
                start: { name: 'è€¶è·¯æ’’å†·', coords: [31.7683, 35.2137] },
                end: { name: 'ç½—é©¬å¸å›½å„åœ°', coords: [41.9028, 12.4964] }, // Rome as representative
                time: 'å…¬å…ƒ70â€“135å¹´',
                background: 'ç½—é©¬å¸å›½ä¸¤æ¬¡é•‡å‹çŠ¹å¤ªèµ·ä¹‰ï¼ˆ70å¹´å’Œ135å¹´ï¼‰åï¼Œè€¶è·¯æ’’å†·åŠç¬¬äºŒåœ£æ®¿è¢«æ¯ã€‚å¹¸å­˜çš„çŠ¹å¤ªäººè¢«æ€æˆ®ã€ä¸ºå¥´æˆ–æµæ•£è‡³å¸å›½å„çœã€‚è¿™æ ‡å¿—ç€æ¼«é•¿çš„çŠ¹å¤ªå¤§æµæ•£å¼€ç«¯ï¼Œæ°‘æ—ä¸­å¿ƒè½¬å…¥æ•£å±…å„åœ°çš„ç¤¾åŒºã€‚',
                proverb_he: '×›×œ ×™×©×¨××œ ×¢×¨×‘×™×Ÿ ×–×” ×‘×–×”',
                proverb_zh: 'å…¨ä½“ä»¥è‰²åˆ—äººçš†å½¼æ­¤ç›¸äº’è´Ÿè´£ã€‚',
                music: { title: 'å¸ƒé²èµ«ã€ŠKol Nidreiã€‹å¤§æç´æ›²', file: 'music/kolnidrei.mp3' }
            },
            {
                start: { name: 'ä¸­ä¸œè…¹åœ°ï¼ˆå¦‚å·´æ ¼è¾¾ï¼‰', coords: [33.3152, 44.3661] }, // Baghdad area
                end: { name: 'å®‰è¾¾å¢æ–¯ï¼ˆç§‘å°”å¤šç“¦ç­‰è¥¿ç­ç‰™å—éƒ¨ï¼‰', coords: [37.8916, -4.7715] }, // Cordoba
                time: 'å…¬å…ƒ8â€“12ä¸–çºª',
                background: 'ç©†æ–¯æ—å¾æœè¥¿ç­ç‰™åï¼ŒçŠ¹å¤ªäººåœ¨å®‰è¾¾å¢æ–¯åœ°åŒºè¿æ¥æ–‡åŒ–â€œé»„é‡‘æ—¶ä»£â€ã€‚åœ¨ç›¸å¯¹å®½å®¹çš„ç¤¾ä¼šç¯å¢ƒä¸­ï¼ŒçŠ¹å¤ªæ•™å¾’åœ¨å®—æ•™ã€å“²å­¦ã€åŒ»å­¦å’Œè¯—æ­Œç­‰é¢†åŸŸå–å¾—æ°å‡ºæˆå°±ï¼Œä¸ç©†æ–¯æ—ã€åŸºç£å¾’å’Œè°å…±å¤„ã€‚',
                proverb_he: '×œ××“ ×œ×©×•× ×š ×œ×•××¨ ××™× ×™ ×™×•×“×¢',
                proverb_zh: 'è¦è®©ä½ çš„èˆŒå¤´å­¦ä¼šè¯´â€œæˆ‘ä¸çŸ¥é“â€ï¼Œè¿™æ ·æ‰èƒ½ä¸æ–­è¿›æ­¥ã€‚',
                music: { title: 'å¡æ³•è¿ªçŠ¹å¤ªæ°‘è°£é£æ ¼éŸ³ä¹', file: 'music/andalus.mp3' } //  placeholder, please provide file
            },
            {
                start: { name: 'è¥¿ç­ç‰™å„åœ°', coords: [37.8916, -4.7715] }, // Cordoba as representative
                end: { name: 'å¥¥æ–¯æ›¼å¸å›½ï¼ˆå¦‚ä¼Šæ–¯å¦å¸ƒå°”ï¼‰', coords: [41.0082, 28.9784] }, // Istanbul
                time: '1492å¹´èµ·',
                background: 'å¤©ä¸»æ•™åŒç‹ä¸‹ä»¤é©±é€ä¸æ„¿æ”¹å®—çš„çŠ¹å¤ªäººï¼Œç»“æŸäº†å®‰è¾¾å¢æ–¯çš„å®½å®¹æ—¶ä»£ã€‚çº¦20ä¸‡å¡æ³•è¿ªçŠ¹å¤ªäººè¢«è¿«ç¦»å¼€è¥¿ç­ç‰™å’Œè‘¡è„ç‰™ï¼Œå¤§æ‰¹æµäº¡è‡³å¥¥æ–¯æ›¼å¸å›½æ²»ä¸‹çš„å·´å°”å¹²ã€åŒ—éå’Œä¸­ä¸œå„åœ°ï¼Œåœ¨ä»–ä¹¡å»¶ç»­æ–‡åŒ–ä¸ä¿¡ä»°ã€‚',
                proverb_he: '××¤×™×œ×• ×—×¨×‘ ×—×“×” ××•× ×—×ª ×¢×œ ×¦×•×•××¨×• ×©×œ ××“×, ××œ ×™×ª×™×™××© ××Ÿ ×”×¨×—××™×',
                proverb_zh: 'å³ä½¿åˆ©åˆƒæ¶åœ¨é¢ˆä¸Šï¼Œä¹Ÿä¸å¯å¯¹ä¸Šè‹çš„æ…ˆæ‚²ç»æœ›ã€‚',
                music: { title: 'æ‹‰è¿ªè¯ºè¯­å¡æ³•è¿ªæ­Œæ›²ã€ŠAdio Keridaã€‹', file: 'music/adio.mp3' } // placeholder, please provide file
            },
            {
                start: { name: 'ä¸­æ¬§å¾·å›½ç­‰åœ°', coords: [50.0647, 19.9450] }, // Krakow area as representative
                end: { name: 'æ³¢å…°ç‹å›½ï¼ˆæ—¥åæ³¢å…°â€“ç«‹é™¶å®›ï¼‰', coords: [52.2297, 21.0122] }, // Warsaw
                time: 'å…¬å…ƒ12â€“16ä¸–çºª',
                background: 'ä¸­ä¸–çºªæ™šæœŸï¼Œå› è¥¿æ¬§é¢‘ç¹çš„è¿«å®³å’Œé©±é€ï¼Œå¤§æ‰¹çŠ¹å¤ªäººè¿å…¥ç›¸å¯¹å®½å®¹çš„æ³¢å…°ã€‚æ³¢å…°ç»Ÿæ²»è€…é¢å¸ƒæ³•ä»¤ä¿éšœçŠ¹å¤ªäººè‡ªæ²»å’Œå®—æ•™è‡ªç”±ï¼Œæ³¢å…°é€æ¸æˆä¸ºæ¬§æ´²çŠ¹å¤ªæ–‡åŒ–ä¸­å¿ƒï¼Œâ€œæ³¢å…°å¤©å ‚â€æ—¶æœŸç¤¾åŒºç¹è£ï¼Œå­•è‚²äº†æ—¥åä¸œæ¬§åºå¤§çš„çŠ¹å¤ªäººå£ã€‚',
                proverb_he: '×× ××™×Ÿ ×× ×™ ×œ×™, ××™ ×œ×™? ×•×›×©×× ×™ ×œ×¢×¦××™, ××” ×× ×™? ×•×× ×œ× ×¢×›×©×™×•, ××™××ª×™?',
                proverb_zh: 'è‹¥æˆ‘ä¸ä¸ºè‡ªå·±ï¼Œè°æ¥ä¸ºæˆ‘ï¼Ÿè‹¥æˆ‘åªä¸ºè‡ªå·±ï¼Œæˆ‘ç®—ä»€ä¹ˆï¼Ÿè‹¥ä¸æ­¤æ—¶ï¼Œæ›´å¾…ä½•æ—¶ï¼Ÿ',
                music: { title: 'ä¼ ç»Ÿä¸œæ¬§å…‹è±å…¹é»˜éŸ³ä¹', file: 'music/klezmer1.mp3' } // placeholder, please provide file
            },
            {
                start: { name: 'çº³ç²¹å é¢†ä¸‹çš„æ¬§æ´²', coords: [50.0647, 19.9450] }, // Krakow area as representative
                end: { name: 'ä¸­å›½ä¸Šæµ·è™¹å£åŒº', coords: [31.2304, 121.4737] }, // Shanghai
                time: '1933â€“1941å¹´',
                background: 'äºŒæˆ˜å‰å¤•ï¼Œçº³ç²¹å¾·å›½é€æ­¥å‰¥å¤ºçŠ¹å¤ªäººç”Ÿå­˜æƒåˆ©ï¼Œå¤§æ‰¹éš¾æ°‘å¯»æ±‚å‡ºè·¯ã€‚å½¼æ—¶ä¸Šæµ·å¯¹çŠ¹å¤ªéš¾æ°‘å®è¡Œå…ç­¾å¼€æ”¾ï¼Œæˆä¸ºç”Ÿå‘½æ–¹èˆŸã€‚ä¸Šä¸‡æ¥è‡ªå¾·å›½ã€å¥¥åœ°åˆ©ç­‰åœ°çš„çŠ¹å¤ªäººåœ¨30å¹´ä»£é€ƒäº¡ä¸Šæµ·ï¼Œåœ¨å¼‚å›½ä»–ä¹¡è‰°éš¾ç»´æŒç¤¾åŒºï¼Œèº²è¿‡äº†æ¬§æ´²çš„æµ©åŠ«ï¼Œç­‰å¾…æˆ˜åé‡å»ºç”Ÿæ´»ã€‚',
                proverb_he: '×›×œ ×”××§×™×™× × ×¤×© ××—×ª ××™×©×¨××œ ×›××™×œ×• ×§×™×™× ×¢×•×œ× ××œ×', // Sanhedrin 37a
                proverb_zh: 'å‡¡æ•‘äººä¸€å‘½ï¼Œå³æ•‘å…¨ä¸–ç•Œã€‚',
                music: { title: 'ç”µå½±ã€Šè¾›å¾·å‹’çš„åå•ã€‹ä¸»é¢˜æ›²', file: 'music/schindler.mp3' }
            },
            {
                start: { name: 'ä¿„å›½éš”ç¦»å®šå±…åŒº', coords: [50.4501, 30.5234] }, // Kyiv area as representative
                end: { name: 'ç¾å›½ç­‰è¥¿æ–¹å›½å®¶', coords: [40.7128, -74.0060] }, // New York
                time: '19ä¸–çºªæœ«â€“20ä¸–çºªåˆ',
                background: 'æ²™çš‡ä¿„å›½æ²»ä¸‹çš„çŠ¹å¤ªäººé•¿æœŸå—é™äºè¥¿éƒ¨çš„â€œéš”ç¦»å®šå±…åŒºâ€ï¼Œä¸”å±¡é­åçŠ¹éªšä¹±ï¼ˆå¦‚1881å¹´å’Œ1903å¹´çš„å¤§è§„æ¨¡æš´åŠ¨ï¼‰ã€‚åœ¨å›°å¢ƒä¸æš´åŠ›ä¸­ï¼Œçº¦æœ‰ä¸¤ç™¾ä¸‡ä¸œæ¬§çŠ¹å¤ªäººäº1880å¹´ä»£èµ·é€ƒç¦»ä¿„å›½ï¼Œè¿œèµ´ç¾å›½ç­‰åœ°å¯»æ±‚å®‰å…¨å’Œæœºé‡ï¼Œä¿ƒæˆäº†ç¾å›½å¤§åŸå¸‚ä¸­çš„çŠ¹å¤ªç§»æ°‘ç¤¾åŒºå…´èµ·ã€‚',
                proverb_he: '×”×–×™×ª ××™×Ÿ ××•×¦×™× ×–×™×ª×™×• ××œ× ×× ×›×Ÿ ×›×ª×©×•×”×•, ×›×š ×™×©×¨××œ ××™×Ÿ × ×’××œ×™× ×¢×“ ×©×™×ª×™×™×¡×¨×•', // Midrash Tanchuma Vayeshev 9 (idea, wording varies)
                proverb_zh: 'æ©„æ¦„å”¯æœ‰å—å‹æ¦¨æ‰èƒ½å‡ºæ²¹ï¼Œäººå”¯æœ‰ç»å†ç£¨éš¾æ‰èƒ½åšéŸ§ã€‚',
                music: { title: 'ä¼ ç»Ÿå…‹è±å…¹é»˜éŸ³ä¹', file: 'music/klezmer1.mp3' } // placeholder, please provide file
            },
            {
                start: { name: 'ä¸–ç•Œå„ä¾¨å±…åœ°', coords: [35, 0] }, // Central Mediterranean as representative
                end: { name: 'å·´å‹’æ–¯å¦/ä»¥è‰²åˆ—', coords: [31.7683, 35.2137] }, // Jerusalem area
                time: '19ä¸–çºªæœ«â€“20ä¸–çºªä¸­å¶',
                background: 'éšç€19ä¸–çºªæœ«é”¡å®‰ä¸»ä¹‰å…´èµ·ï¼Œæµæ•£å„åœ°çš„çŠ¹å¤ªäººå¼€å§‹å‘ç¥–å…ˆæ•…åœŸå·´å‹’æ–¯å¦è¿ç§»ï¼ˆé˜¿åˆ©äºšè¿åŠ¨ï¼‰ã€‚ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ˜åï¼Œå¤§æ‰¹å¹¸å­˜è€…å’Œä¾¨æ°‘æ¶Œå…¥è‹±å±å·´å‹’æ–¯å¦æ‰˜ç®¡åœ°ã€‚1948å¹´ä»¥è‰²åˆ—å»ºå›½ï¼Œå®ç°äº†ä¸¤åƒå¹´æµäº¡åçš„å¤å›½æ¢¦æƒ³ã€‚',
                proverb_he: '×œ×©× ×” ×”×‘××” ×‘×™×¨×•×©×œ×™×',
                proverb_zh: 'æ˜å¹´åœ¨è€¶è·¯æ’’å†·ï¼',
                music: { title: 'ä»¥è‰²åˆ—å›½æ­Œã€Šhatikvahã€‹', file: 'music/hatikvah.mp3' }
            }
        ];

        // Helper function to calculate a control point for a curved line
        function getCurvedControlPoint(start, end, migrationIndex, maxOffsetDegrees = 25, distanceScale = 100) {
            const startLatLng = L.latLng(start);
            const endLatLng = L.latLng(end);

            if (startLatLng.equals(endLatLng, 1e-6)) {
                return [startLatLng.lat, startLatLng.lng];
            }

            const midLat = (startLatLng.lat + endLatLng.lat) / 2;
            let midLng = (startLatLng.lng + endLatLng.lng) / 2;

            if (Math.abs(startLatLng.lng - endLatLng.lng) > 180) {
                midLng = (startLatLng.lng + endLatLng.lng + 360) / 2;
                midLng = (midLng + 180) % 360 - 180;
            }

            const deltaLat = endLatLng.lat - startLatLng.lat;
            const deltaLng = endLatLng.lng - startLatLng.lng;

            const angleRad = Math.atan2(deltaLat, deltaLng);
            const perpAngleRad = angleRad + (migrationIndex % 2 === 0 ? Math.PI / 2 : -Math.PI / 2);

            const distanceDegrees = Math.sqrt(deltaLat * deltaLat + deltaLng * deltaLng);
            const offsetMagnitude = maxOffsetDegrees * Math.min(1, distanceDegrees / distanceScale);

            let controlLat = midLat + offsetMagnitude * Math.sin(perpAngleRad);
            let controlLng = midLng + offsetMagnitude * Math.cos(perpAngleRad);

            controlLng = (controlLng + 180) % 360 - 180;

            return [controlLat, controlLng];
        }

        const uniqueLocations = {};

        migrations.forEach(migration => {
            const startKey = migration.start.coords.join(',');
            const endKey = migration.end.coords.join(',');

            if (!uniqueLocations[startKey]) {
                uniqueLocations[startKey] = {
                    name: migration.start.name,
                    coords: migration.start.coords,
                    isStart: true,
                    isEnd: false,
                    startMigrations: [migration],
                    endMigrationData: null,
                    marker: null
                };
            } else {
                uniqueLocations[startKey].isStart = true;
                if (!uniqueLocations[startKey].startMigrations) uniqueLocations[startKey].startMigrations = [];
                uniqueLocations[startKey].startMigrations.push(migration);
            }

            if (!uniqueLocations[endKey]) {
                uniqueLocations[endKey] = {
                    name: migration.end.name,
                    coords: migration.end.coords,
                    isStart: false,
                    isEnd: true,
                    startMigrations: [],
                    endMigrationData: migration,
                    marker: null
                };
            } else {
                uniqueLocations[endKey].isEnd = true;
                uniqueLocations[endKey].endMigrationData = migration;
            }
        });

        const allMarkerCoords = [];
        const ancientEgyptKey = migrations[0].start.coords.join(',');

        Object.keys(uniqueLocations).forEach(key => {
            const locationData = uniqueLocations[key];
            const coords = locationData.coords;
            let marker;

            const shouldCreateMarker = locationData.isEnd || (locationData.isStart && !locationData.isEnd);

            if (!shouldCreateMarker) {
                return;
            }

            marker = L.marker(coords, { icon: starOfDavidIcon });
            allMarkerCoords.push(coords);

            if (key === ancientEgyptKey) {
                const egyptMigration = migrations[0];
                const egyptPopupContent = `
                    <div class="popup-title">${egyptMigration.start.name}</div>
                    <div class="popup-music-inline">
                        <span class="music-title-inline">${egyptMigration.music.title}</span>
                        <audio controls preload="none" controlsList="nodownload noplaybackrate">
                            <source src="${egyptMigration.music.file}" type="audio/mpeg">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>
                    </div>
                    <div class="popup-section">
                        <h4>ç›¸å…³äº‹ä»¶ï¼šå‡ºåŸƒåŠ</h4>
                        <p>${egyptMigration.time}</p>
                    </div>
                    <div class="popup-section">
                        <h4>èƒŒæ™¯ï¼š</h4>
                        <p class="popup-background">${egyptMigration.background}</p>
                    </div>
                    <div class="popup-section">
                        <h4>å¡”æœ¨å¾·ç®´è¨€ï¼š</h4>
                        <p class="popup-proverb">
                            <span class="hebrew" lang="he">${egyptMigration.proverb_he}</span>
                            <span class="chinese">${egyptMigration.proverb_zh}</span>
                        </p>
                    </div>
                `;
                marker.bindPopup(egyptPopupContent, {
                    maxWidth: 800,
                    autoPan: true,
                    autoPanPadding: L.point(80, 80)
                });

                marker.on('popupopen', function () {
                    try {
                        document.querySelectorAll('audio').forEach(otherAudio => { /* ... pause logic ... */ });
                        const audio = this.getPopup()?.getContent().querySelector('audio');
                        if (audio) {
                            audio.play().catch(error => console.warn("Audio autoplay failed:", error));
                        }
                    } catch (e) { console.error("Error on audio popupopen:", e); }
                });
                marker.on('popupclose', function () {
                    try {
                        const audio = this.getPopup()?.getContent().querySelector('audio');
                        if (audio && !audio.paused) {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    } catch (e) { console.error("Error on audio popupclose:", e); }
                });

            } else if (locationData.isEnd) {
                const migration = locationData.endMigrationData;
                if (migration) {
                    const endPopupContent = `
                    <div class="popup-title">${migration.end.name}</div>
                    <div class="popup-music-inline">
                        <span class="music-title-inline">${migration.music.title}</span>
                        <audio controls preload="none" controlsList="nodownload noplaybackrate">
                            <source src="${migration.music.file}" type="audio/mpeg">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                        </audio>
                    </div>
                    <div class="popup-section">
                        <h4>æ—¶é—´ï¼š</h4>
                        <p>${migration.time}</p>
                    </div>
                    <div class="popup-section">
                        <h4>èƒŒæ™¯ï¼š</h4>
                        <p class="popup-background">${migration.background}</p>
                    </div>
                    <div class="popup-section">
                        <h4>å¡”æœ¨å¾·ç®´è¨€ï¼š</h4>
                        <p class="popup-proverb">
                            <span class="hebrew" lang="he">${migration.proverb_he}</span>
                            <span class="chinese">${migration.proverb_zh}</span>
                        </p>
                    </div>
                `;
                    marker.bindPopup(endPopupContent, {
                        maxWidth: 800,
                        autoPan: true,
                        autoPanPadding: L.point(80, 80)
                    });

                    marker.on('popupopen', function () { /* ... audio play logic ... */ });
                    marker.on('popupclose', function () { /* ... audio stop logic ... */ });
                }

            } else if (locationData.isStart && !locationData.isEnd) {
                const startPopupContent = `
                <div class="popup-title">${locationData.name}</div>
                <div class="popup-section">
                    <h4>è¿å¾™èµ·ç‚¹</h4>
                    <p>æ­¤åœ°æ˜¯ä»¥ä¸‹è¿å¾™çš„èµ·ç‚¹ï¼š</p>
                    <ul>
                        ${locationData.startMigrations.map(mig => `<li>è‡³ ${mig.end.name} (${mig.time})</li>`).join('')}
                    </ul>
                </div>
            `;
                marker.bindPopup(startPopupContent, {
                    maxWidth: 800,
                    autoPan: true,
                    autoPanPadding: L.point(80, 80)
                });
            }

            marker.addTo(map);

            const tooltip = marker.bindTooltip(locationData.name, { /* ... tooltip options ... */ });

            uniqueLocations[key].marker = marker;
        });

        migrations.forEach((migration, index) => {
            const startKey = migration.start.coords.join(',');
            const endKey   = migration.end.coords.join(',');
            const startLocation = uniqueLocations[startKey];
            const endLocation   = uniqueLocations[endKey];
            if (!startLocation || !endLocation) return;

            const startPos = startLocation.marker ? startLocation.marker.getLatLng()
                                                : L.latLng(startLocation.coords);
            const endPos   = endLocation.marker   ? endLocation.marker.getLatLng()
                                                : L.latLng(endLocation.coords);

            const ctrlArr = getCurvedControlPoint(
                [startPos.lat, startPos.lng],
                [endPos.lat,   endPos.lng], index
            );
            const ctrlLL = L.latLng(ctrlArr[0], ctrlArr[1]);

            const curve = L.curve(
                ['M', [startPos.lat, startPos.lng],
                'Q', ctrlArr,
                [endPos.lat,   endPos.lng]],
                {color:'#0056b3', weight:3, opacity:.9}
            ).addTo(map);

            function sampleQuadBezier(p0, p1, p2, n = 60){
                const pts = [];
                for(let i=0;i<=n;i++){
                    const t = i/n, u = 1-t;
                    const lat = u*u*p0.lat + 2*u*t*p1.lat + t*t*p2.lat;
                    const lng = u*u*p0.lng + 2*u*t*p1.lng + t*t*p2.lng;
                    pts.push([lat, lng]);
                }
                return pts;
            }
            const polylinePoints = sampleQuadBezier(startPos, ctrlLL, endPos, 60);

            L.polylineDecorator(polylinePoints,{
                patterns:[{
                    offset:'8%',
                    repeat:50,
                    symbol:L.Symbol.arrowHead({
                        pixelSize:10,
                        headAngle:60,
                        polygon:true,
                        pathOptions:{
                            color:'#0056b3',
                            weight:0,
                            fillOpacity:1
                        }
                    })
                }]
            }).addTo(map);

        });

        const allRouteCoords = [];
        migrations.forEach(mig => {
            allRouteCoords.push(mig.start.coords);
            allRouteCoords.push(mig.end.coords);
        });

        const bounds = L.latLngBounds(allRouteCoords);

        map.invalidateSize();
        setTimeout(() => { map.invalidateSize(); }, 200);

        const infoBar = document.querySelector('.info-bar');
        const toggleButton = document.getElementById('info-toggle-button');
        const infoContent = document.querySelector('.info-content');

        toggleButton.addEventListener('click', function () {
            const isCollapsed = infoBar.classList.toggle('collapsed');
            toggleButton.textContent = isCollapsed ? 'å±•å¼€é¡¹ç›®è¯´æ˜' : 'æ”¶èµ·é¡¹ç›®è¯´æ˜';

            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        });

        window.addEventListener('resize', () => {
            map.invalidateSize();
            const isDesktop = window.matchMedia("(min-width: 768px)").matches;
            if (infoBar.classList.contains('collapsed')) {
                toggleButton.textContent = isDesktop ? 'æ”¶èµ·' : 'å±•å¼€';
            } else {
                toggleButton.textContent = 'æ”¶èµ·';
            }
        });

        toggleButton.textContent = 'æ”¶èµ·';

        let autoPlayState = {
            isPlaying: false,
            currentIndex: 0,
            timer: null,
            playButton: null
        };

        function createAutoPlayControls() {
            const controlsContainer = L.DomUtil.create('div', 'auto-play-controls');
            controlsContainer.style.position = 'absolute';
            controlsContainer.style.bottom = '20px';
            controlsContainer.style.left = '20px';
            controlsContainer.style.zIndex = '1000';
            controlsContainer.style.display = 'flex';
            controlsContainer.style.flexDirection = 'row';
            controlsContainer.style.alignItems = 'center';
            controlsContainer.style.background = 'rgba(255, 255, 255, 0.8)';
            controlsContainer.style.padding = '10px';
            controlsContainer.style.borderRadius = '8px';
            controlsContainer.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.3)';
            
            const playButton = L.DomUtil.create('button', 'play-button', controlsContainer);
            playButton.innerHTML = 'â–¶ï¸ å¼€å§‹æ—…ç¨‹';
            playButton.style.background = '#0056b3';
            playButton.style.color = 'white';
            playButton.style.border = 'none';
            playButton.style.borderRadius = '5px';
            playButton.style.padding = '8px 15px';
            playButton.style.cursor = 'pointer';
            playButton.style.fontSize = '14px';
            playButton.style.fontWeight = 'bold';
            playButton.style.display = 'flex';
            playButton.style.alignItems = 'center';
            playButton.style.justifyContent = 'center';
            
            const statusText = L.DomUtil.create('div', 'status-text', controlsContainer);
            statusText.innerHTML = 'ç‚¹å‡»å¼€å§‹çŠ¹å¤ªæ°‘æ—è¿å¾™å†å²ä¹‹æ—…';
            statusText.style.marginLeft = '10px';
            statusText.style.color = '#333';
            statusText.style.fontSize = '14px';
            
            document.querySelector('#mapid').appendChild(controlsContainer);
            
            autoPlayState.playButton = playButton;
            autoPlayState.statusText = statusText;
            
            playButton.addEventListener('click', toggleAutoPlay);
            
            L.DomEvent.disableClickPropagation(controlsContainer);
        }

        function toggleAutoPlay() {
            if (autoPlayState.isPlaying) {
                stopAutoPlay();
            } else {
                startAutoPlay();
            }
        }

        function startAutoPlay() {
            autoPlayState.isPlaying = true;
            autoPlayState.playButton.innerHTML = 'â¸ï¸ æš‚åœæ—…ç¨‹';
            
            if (autoPlayState.currentIndex >= migrations.length) {
                autoPlayState.currentIndex = 0;
            }
            
            playCurrentMigration();
        }

        function stopAutoPlay() {
            autoPlayState.isPlaying = false;
            autoPlayState.playButton.innerHTML = 'â–¶ï¸ ç»§ç»­æ—…ç¨‹';
            
            if (autoPlayState.timer) {
                clearTimeout(autoPlayState.timer);
                autoPlayState.timer = null;
            }
            
            document.querySelectorAll('.migration-line-highlight').forEach(element => {
                element.classList.remove('migration-line-highlight');
            });
        }

        function playCurrentMigration() {
            if (!autoPlayState.isPlaying) return;
            
            const migration = migrations[autoPlayState.currentIndex];
            if (!migration) return;
            
            autoPlayState.statusText.innerHTML = `${autoPlayState.currentIndex + 1}/${migrations.length}: ${migration.start.name} â†’ ${migration.end.name}`;
            
            const startKey = migration.start.coords.join(',');
            const endKey = migration.end.coords.join(',');
            const startLocation = uniqueLocations[startKey];
            const endLocation = uniqueLocations[endKey];
            
            highlightMigrationPath(autoPlayState.currentIndex);
            
            const bounds = L.latLngBounds([startLocation.coords, endLocation.coords]);
            map.fitBounds(bounds, { padding: [100, 100], maxZoom: 5, duration: 1 });
            
            setTimeout(() => {
                const backupTimer = setTimeout(() => {
                    console.log("å¤‡ä»½å®šæ—¶å™¨è§¦å‘ï¼Œå¼ºåˆ¶å‰è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ");
                    moveToNextMigration();
                }, 10000);
                
                if (endLocation && endLocation.marker) {
                    endLocation.marker.openPopup();
                    
                    const popupContent = endLocation.marker.getPopup().getContent();
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = popupContent;
                    const audio = tempDiv.querySelector('audio');
                    
                    if (audio) {
                        const audioSrc = audio.querySelector('source').getAttribute('src');
                        const playbackAudio = new Audio(audioSrc);
                        
                        playbackAudio.addEventListener('ended', () => {
                            clearTimeout(backupTimer);
                            moveToNextMigration();
                        });
                        
                        playbackAudio.play().catch(error => {
                            console.warn("è‡ªåŠ¨æ’­æ”¾å¤±è´¥:", error);
                            autoPlayState.timer = setTimeout(() => {
                                clearTimeout(backupTimer);
                                moveToNextMigration();
                            }, 6000);
                        });
                        
                        autoPlayState.currentAudio = playbackAudio;
                    } else {
                        autoPlayState.timer = setTimeout(() => {
                            clearTimeout(backupTimer);
                            moveToNextMigration();
                        }, 4000);
                    }
                } else {
                    autoPlayState.timer = setTimeout(() => {
                        clearTimeout(backupTimer);
                        moveToNextMigration();
                    }, 3000);
                }
            }, 1000);
        }

        function moveToNextMigration() {
            if (autoPlayState.currentAudio && !autoPlayState.currentAudio.paused) {
                autoPlayState.currentAudio.pause();
                autoPlayState.currentAudio = null;
            }
            
            if (autoPlayState.timer) {
                clearTimeout(autoPlayState.timer);
                autoPlayState.timer = null;
            }
            
            removeAllPathHighlights();
            
            map.closePopup();
            
            autoPlayState.currentIndex++;
            
            if (autoPlayState.currentIndex >= migrations.length) {
                autoPlayState.statusText.innerHTML = 'è¿å¾™ä¹‹æ—…å·²å®Œæˆ!';
                autoPlayState.playButton.innerHTML = 'ğŸ”„ é‡æ–°å¼€å§‹';
                autoPlayState.isPlaying = false;
                return;
            }
            
            playCurrentMigration();
        }

        function highlightMigrationPath(index) {
            removeAllPathHighlights();
            
            const paths = document.querySelectorAll('.leaflet-curve-pane path');
            
            if (paths[index]) {
                paths[index].classList.add('migration-line-highlight');
            }
        }

        function removeAllPathHighlights() {
            document.querySelectorAll('.leaflet-curve-pane path').forEach(path => {
                path.classList.remove('migration-line-highlight');
            });
        }

        createAutoPlayControls();

        const style = document.createElement('style');
        style.textContent = `
            .migration-line-highlight {
                stroke: #FFDA00 !important;
                stroke-width: 5 !important;
                stroke-opacity: 1 !important;
                stroke-dasharray: 10, 5;
                animation: dashdraw 1s linear infinite;
            }
            
            @keyframes dashdraw {
                0% {
                    stroke-dashoffset: 15;
                }
                100% {
                    stroke-dashoffset: 0;
                }
            }
        `;
        document.head.appendChild(style);

    </script>

</body>

</html>